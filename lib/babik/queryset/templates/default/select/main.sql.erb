<% model = queryset.model %>

<% inclusion_filters = queryset.inclusion_filters %>
<% has_inclusion_filters = inclusion_filters.length.positive? %>

<% exclusion_filters = queryset.exclusion_filters %>
<% has_exclusion_filters = exclusion_filters.length.positive? %>

<% aggregations = queryset.aggregations %>

SELECT

  <% if queryset.lock? %>
    <%= queryset._lock_type %>
  <% end %>

  <% if queryset.distinct? %>
    DISTINCT
  <% end %>

  <% if aggregations.length > 0 %>
    <% aggregations.each do |aggregation| %>
      <%= aggregation.sql_select %>
    <% end %>
  <% else %>
    <% if queryset.projection? %>
      <%# Projection of the results %>
      <%= render.('select/projection.sql.erb', {queryset: queryset}) %>
    <% else %>
      <%= model.table_name %>.*
      <% if queryset.select_related? %>
        ,
        <%= render.('select/select_related.sql.erb', {queryset: queryset}) %>
      <% end %>
    <% end %>

  <% end %>

FROM <%= model.table_name %>

<%= queryset.sql.left_joins %>

<% if has_inclusion_filters || has_exclusion_filters  %>
WHERE (
  <% if has_inclusion_filters %>
  (
    <% inclusion_filters.each_with_index do |condition, condition_index| %>
      <% last_inclusion_filter = condition_index == inclusion_filters.length - 1 %>
      (
        1=1
        <% if condition.class == Array %>
          AND ( 1=0
            <% condition.each do |disjunction| %>
              OR <%= disjunction.sql_where_condition %>
            <% end %>
          )
        <% else %>
          AND (<%= condition.sql_where_condition %>)
        <% end %>
      )
      <% unless last_inclusion_filter %>
      AND
      <% end %>
    <% end %>
  )
  <% end %>

  <% if has_inclusion_filters && has_exclusion_filters %>
    AND
  <% end %>

  <% if has_exclusion_filters %>
  ( NOT (
    <% exclusion_filters.each_with_index do |condition, condition_index| %>
      <% last_exclusion_filter = condition_index == exclusion_filters.length - 1 %>
      (
        1=1
        <% if condition.class == Array %>
          AND ( 1=0
          <% condition.each do |disjunction| %>
            OR <%= disjunction.sql_where_condition %>
          <% end %>
          )
        <% else %>
          AND (<%= condition.sql_where_condition %>)
        <% end %>
      )
      <% unless last_exclusion_filter %>
      AND
      <% end %>
    <% end %>
  ) )
<% end %>
)
<% end %>
<%# Order the results %>
<%= render.('select/order_by.sql.erb', {queryset: queryset}) %>

<%# Limit the results (only MySQL, MariaDB and PostgreSQL) %>
<%= render.('select/limit.sql.erb', {queryset: queryset}) %>
