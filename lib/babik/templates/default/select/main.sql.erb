<% model = queryset.model %>
<% filters = queryset.filters %>
<% is_count = queryset.is_count %>
<% has_distinct = queryset.has_distinct %>
<% limit = queryset.limit %>
<% offset = queryset.offset %>
<% order = queryset.order %>
<% lock_type = queryset.lock_type %>

SELECT
  <% if lock_type %>
    <%= lock_type %>
  <% end %>
  <% if has_distinct %>
    DISTINCT
  <% end %>
  <% if is_count %>
    COUNT(<%= model.table_name %>.id) AS number_of_rows
  <% else %>
    <%= model.table_name %>.*
  <% end %>
FROM <%= model.table_name %>

<%= queryset._sql_left_joins %>

WHERE (
  1=1
  <% filters.each do |conjunction| %>
    AND (
      1=1
      <% if conjunction.class == Array %>
        AND ( 1=0
          <% conjunction.each do |disjunction| %>
            OR <%= disjunction.sql_where_condition %>
          <% end %>
        )
      <% else %>
        AND (<%= conjunction.sql_where_condition %>)
      <% end %>
    )
  <% end %>
)
<%# Limit the results (only MySQL, MariaDB and PostgreSQL) %>
<% unless limit.nil? %>
  LIMIT <%= limit %>
  <% unless offset.nil? %>
    OFFSET <%= offset %>
  <% end %>
<% end %>
<%# Order the results %>
<% unless order.nil? %>
  ORDER BY
    <% order.each_with_index do |order_field, order_field_index| %>
      <% last_one = order_field_index == order.length - 1 %>
      <% order_path = order_field[0] %>
      <% order_selection = Selection.factory(model, order_path, 'xx') %>
      <% if order_selection.class == ForeignSelection %>
        <%= order_selection.left_joins[-1].alias %>.<%= order_selection.selected_field %> <%= order_field[1] %> <% unless last_one %>,<% end %>
      <% else %>
        <%= model.table_name %>.<%= order_field[0] %> <%= order_field[1] %> <% unless last_one %>,<% end %>
      <% end %>
  <% end %>
<% end %>